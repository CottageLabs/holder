<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
    <meta charset="utf-8">
    <title>Holder</title>
    <meta name="description" content="">
    <meta name="author" content="Cottage Labs">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script type="text/javascript" src="lib/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="lib/bootstrap-3.0.3/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="lib/bootstrap-3.0.3/css/bootstrap.min.css">
    <script type="text/javascript" src="lib/d3/d3.min.js"></script>

    <script type="text/javascript" src="views/network.js"></script>
    <script type="text/javascript" src="views/chart.js"></script>
    <script type="text/javascript" src="jquery.holder.js"></script>

    <style>
    .holder-chart text {
        fill: white;
        font: 10px sans-serif;
        text-anchor: end;
    }
    </style>
</head>

<body>
    <!--
    <div class="holder holder-loading" style="position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;background-color:red;color:black;font-size:10em;margin:10px;">HOLDER IS LOADING :)</div>-->
    <div class="container-fluid" style="margin:5px;">
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default holder holder-ui">
                    <div class="panel-heading" style="background-color:white;padding:0px;">
                        <div class="input-group" style="margin-left:-1px;margin-top:-1px;margin-bottom:-6px;margin-right:-2px;">
                            <div class="input-group-btn">
                                <a href="#" class="btn btn-default holder holder-function" holder-function="prev" alt="previous" title="previous" style="height:50px;font-size:1.6em;">&lt;</a>
                            </div>
                            <!--
                            <div class="input-group-btn">
                                <input type="text" class="form-control holder holder-from holder-function" holder-function="from" placeholder="0" style="font-size:1.6em;height:50px;width:60px;">
                            </div>
                            -->
                            <input type="text" class="form-control holder holder-search holder-function" holder-function="add" placeholder="search..." style="font-size:1.6em;height:50px;">
                            <div class="input-group-btn">
                                <a href="#" class="btn btn-default holder holder-toggle" holder-toggle="sink" alt="show/hide search options" title="show/hide search options" style="height:50px;font-size:1.6em;">: :</a>
                                <!--
                                <input type="text" class="form-control holder holder-to holder-function" holder-function="to" placeholder="?" style="font-size:1.6em;height:50px;width:60px;margin:0 -5px 0 -5px;">
                                -->
                                <a href="#" class="btn btn-default holder holder-function" holder-function="next" alt="next" title="next" style="height:50px;font-size:1.6em;">&gt;</a>
                            </div>
                        </div>
                        <div class="holder holder-filters" style="margin-top:5px;"></div>
                    </div>
                    <div class="panel-body section holder holder-panel-sink" style="display:none;">
                        <div class="col-md-9 holder holder-panel-suggestions" style="border-right:1px solid #ccc;"></div>
                        <div class="col-md-3 holder holder-panel-settings">
                            <p>SETTINGS</p>
                            <p><input type="checkbox" class="holder" checked="checked"> show tags</p>
                            <p><input type="checkbox" class="holder" checked="checked"> show entities</p>
                            <p><input type="checkbox" class="holder"> show answers</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <div class="holder holder-journals" style="height:500px;overflow:scroll;outline:2px solid #ccc;"></div>
            </div>
            <div class="col-md-3">
                <div class="holder holder-results" style="height:500px;overflow:scroll;outline:2px solid #ccc;"></div>
            </div>
            <div class="col-md-7">
                <div class="holder holder-vis" style="height:500px;outline:2px solid #ccc;"></div>
            </div>
        </div>
        <div class="row" style="margin-top:10px;">
            <div class="col-md-2">
                <div class="holder holder-authors" style="height:500px;overflow:scroll;outline:2px solid #ccc;"></div>
            </div>
            <div class="col-md-3">
                <div class="holder holder-something" style="height:500px;overflow:scroll;outline:2px solid #ccc;"></div>
            </div>
            <div class="col-md-7">
                <div style="height:500px;width:100%;overflow:scroll;outline:2px solid #ccc;">
                    <svg class="holder holder-chart" style="width:100%;overflow:scroll;"></svg>
                </div>
            </div>
        </div>
    </div>

    
<script>
jQuery(document).ready(function() {

    // *****************************************************************************
    // THE FUNCTIONS FOR BUILDING THE RESULTS AREA FOR DOAJ EXAMPLE DATA

    var result = function(data) {
        if ( ! ( 'title' in data ) ) { return '<tr><td>' + JSON.stringify(data) + '</td></tr>'; }

        var url = '';
        if ( 'identifier' in data ) {
            for ( var i in data.identifier ) {
                if ( data.identifier[i].type && data.identifier[i].type.toLowerCase() === 'doi' ) {
                    url= 'http://dx.doi.org/' + data.identifier[i].id;
                }
            }
        }
        if ( url === '' && 'link' in data ) {
            url = data.link[0].url;
        }

        var details = '<tr><td>';
        if ( url !== '' ) {
            details += '<h4><a target="_blank" href="' + url + '">' + data.title + '</a></h4>';	
        } else {
            details += '<h4>' + data.title + '</h4>';
        }
        details += '<p>';
        if ( 'author' in data ) {
            details += 'by ';
            for ( var i in data.author ) {
                if ( i != 0 ) {
                    details += ', ';
                }
                details += searchify({class: 'holder', val: data.author[i].name, attrs: {function: 'add', filter: 'bibjson.author.name.exact', value: data.author[i].name} });
            }
            details += '<br>';
        }
        if ( 'journal' in data ) {
            details += 'in <i>';
            details += searchify({class: 'holder', val: data.journal.title, attrs: {function: 'add', filter: 'bibjson.journal.title.exact', value: data.journal.title} });
            details += '</i> ';
            if ( 'volume' in data.journal ) { details += data.journal.volume + ' '; }
            if ( 'issue' in data.journal ) { details += data.journal.issue + ' '; }
            if ( 'number' in data.journal ) { details += data.journal.number + ' '; }
            if ( 'year' in data.journal ) {
                details += ' (';
                details += searchify({class: 'holder', val: data.journal.year, attrs: {function: 'add', filter: 'bibjson.journal.year.exact', value: data.journal.year} });
                details += ') ';
            } else if ( 'year' in data ) {
                details += ' (';
                details += searchify({class: 'holder', val: data.year, attrs: {function: 'add', filter: 'bibjson.year.exact', value: data.year} });
                details += ') ';
            }
        }
        details += '</p>';
        var kw = [];
        if ( 'keywords' in data ) { kw = kw.concat(data.keywords); }
        if ( 'subject' in data ) {
            var s = [];
            for ( var ss in data.subject ) {
                s.push(data.subject[ss].term);
            }
            kw = kw.concat(s); 
        }
        kw = unique(kw);
        if ( kw.length !== 0 ) {
            details += '<p>';
            for ( var i in kw ) {
                if ( i != 0 ) { details += ', '; }
                details += searchify({class: 'holder', val: kw[i], attrs: {function: 'add', query: kw[i] } });
            }
            details += '</p>';
        }
        if ( 'abstract' in data ) {
            //details += '<p>' + data.abstract + '</p>';
        }
        details += '</td></tr>';
        return details;
    }
    var results = function(data) {
        var disp = '<table class="table table-striped table-bordered">';
        for ( var r in data.hits.hits ) {
            disp += result(data.hits.hits[r]['_source'].bibjson);
        }
        disp += '</table>';
        $('.holder.holder-results').html(disp);
    }
    // *****************************************************************************

    
    // *****************************************************************************
    // AN EXAMPLE FUNCTION DISPLAYING FACET LISTINGS FROM DOAJ DATA

    var facets = function(data) {
        // could just loop over all data.aggregations, and append them all in tables to one div, 
        // but these two cases handle them specifically and put them to predefined divs.
        var disp = '<table class="table table-striped table-bordered">';
        for ( var r in data.aggregations["bibjson.journal.title.exact"].buckets ) {
            var j = data.aggregations["bibjson.journal.title.exact"].buckets[r];
            disp += '<tr><td>';
            disp += searchify({class: 'holder', val: j.key + ' (' + j.doc_count + ')', attrs: {function: 'add', filter: 'bibjson.journal.title.exact', value: j.key} });
            disp += '</td></tr>';
        }
        disp += '</table>';
        $('.holder.holder-journals').html(disp);

        var disp = '<table class="table table-striped table-bordered">';
        for ( var r in data.aggregations["bibjson.author.name.exact"].buckets ) {
            var j = data.aggregations["bibjson.author.name.exact"].buckets[r];
            disp += '<tr><td>';
            disp += searchify({class: 'holder', val: j.key + ' (' + j.doc_count + ')', attrs: {function: 'add', filter: 'bibjson.author.name.exact', value: j.key} });
            disp += '</td></tr>';
        }
        disp += '</table>';
        $('.holder.holder-authors').html(disp);
    }
    // *****************************************************************************



    
    
    
    

    
    
    
    // *****************************************************************************

    
    $('body').holder({
        //"url": "http://localhost:9200/doaj/article/_search",
        "url": "https://doaj.org/query/article/_search",
        "what": "search experiment",
        "results": {
            "default": results,
            "facets": facets,
            "network": network,
            "chart": chart
        },
        "aggregations": {
            "bibjson.journal.title.exact": { "terms": { "field": "bibjson.journal.title.exact" } }
        }
    }); 

    
    
    
    
    
    
    
// a function to simplify down to unique values
var unique = function(a) {
    for ( var i=0; i<a.length; ++i ) {
        for ( var j=i+1; j<a.length; ++j ) {
            if ( a[i] === a[j] ) {
                a.splice(j--, 1);
            }
        }
    }
    return a;
};

// flatten an object like ES. This may not actually be used, and may still not give output as expected
var flatten = function(ob) {
    var toReturn = {};
    for ( var i in ob ) {
        if ( !ob.hasOwnProperty(i) ) continue;
        if ( typeof ob[i] === 'object' && ob[i] !== null ) {
            // but what if list of objects? want to collapse them up too, but not numbered toString.call(ob[i]) === '[object Array]'
            var flatObject = flatten(ob[i]);
            for ( var x in flatObject ) {
                if ( !flatObject.hasOwnProperty(x) ) continue;
                //toReturn[i + '.' + x] = flatObject[x];
                var kn = i + (isNaN(parseInt(x)) ? '.' + x : '');
                if ( toReturn[kn] !== undefined ) {
                    if (typeof toReturn[kn] === 'string') toReturn[kn] = [toReturn[kn]];
                    toReturn[kn].push(flatObject[x]);                    
                } else {
                    toReturn[kn] = flatObject[x];
                }
            }
        } else {
            toReturn[i] = ob[i];
        }
    }
    return toReturn;
};

var full = false;
var parent = '';
var fullscreen = function(event) {
    event.preventDefault();
    if ( full ) {
        $('.graphview').prependTo(parent);
        $('.graphview').css({
            background: 'none',
            position:'static',
            "z-index": 1,
            height: '100%',
            width: '100%'
        })
        full = false;
    } else {
        parent = $('.graphview').parent();
        $('.graphview').prependTo('body');
        $('.graphview').css({
            position:'absolute',
            background: 'white',
            top: '5px',
            left: '5px',
            bottom: '5px',
            right: '5px',
            "z-index": 100000000
        })
        full = true;
    }
}

    
});
</script>
        
    
</body>
</html>